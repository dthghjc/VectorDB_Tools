# uv 工作流指南 ⚡️

本文档为本项目后端开发的 `uv` 工作流指南。我们使用 `uv` 进行环境管理和依赖解析，旨在统一开发环境、保证构建的可复现性，并利用其无与-伦比的速度提升开发效率。

**锁定文件**: 本项目使用 `uv.lock` 作为唯一的依赖锁定文件，以确保最高的安全性和环境一致性。

---

### 1. 首次配置项目 (For Newcomers)

对于**首次**从代码库克隆本项目，并需要在本地从零开始配置环境的开发者，请**严格按顺序**执行以下所有步骤。

**步骤 1.1: 初始化项目配置文件 (如果需要)**
此命令会创建一个 `pyproject.toml` 文件，它是我们项目依赖的“设计蓝图”。
> **注意**: 如果项目中已经存在 `pyproject.toml` 文件，请跳过此步。
```bash
uv init
```

**步骤 1.2: 创建指定版本的虚拟环境**
为了保证团队环境绝对一致，我们强制使用指定的 Python 版本（例如 3.11）来创建虚拟环境。
```bash
# 首先，你可以通过 `uv python list` 查看 uv 在你系统上发现了哪些可用的 Python 版本。
# 然后，在创建环境时通过 `-p` 或 `--python` 参数指定版本：
uv venv -p 3.11
```
此命令将在当前目录下创建一个 `.venv` 文件夹，作为我们项目的隔离环境。

**步骤 1.3: 安装所有依赖**
此命令会读取 `pyproject.toml` 和 `uv.lock` 文件，并将所有锁定的依赖精确地安装到你刚刚创建的 `.venv` 中。
```bash
uv pip sync
```
至此，你的本地开发环境已配置完毕，并与团队标准完全一致。

---

### 2. 日常开发工作流 (Daily Workflow)

在日常开发中，请使用以下 `uv` 命令来管理项目。

**核心理念**: 我们使用 `uv run` 来执行所有命令。这可以确保命令总是在正确的虚拟环境中运行，**因此无需手动运行 `source .venv/bin/activate`**。

| 任务 | 命令 |
| :--- | :--- |
| **运行开发服务器** | `uv run uvicorn main:app --reload` |
| **添加新依赖** | `uv add "package-name"` |
| **移除依赖** | `uv remove "package-name"` |
| **运行测试** | `uv run pytest` |
| **查看依赖树** | `uv tree` |
| **更新所有依赖** | 详见下方“维护与升级”部分 |

---

### 3. 维护与升级 (Maintenance & Upgrades)

**场景**:
1.  当你需要将所有现有依赖更新到最新的兼容版本时（例如，为了获取安全补丁或新功能）。
2.  当你手动修改了 `pyproject.toml` 文件中的版本约束，需要重新生成锁定文件时。

**工作流程**:

**步骤 3.1: 重新编译并锁定依赖**
此命令会检查 `pyproject.toml` 中的版本约束，查找最新的兼容包版本，然后生成或重写 `uv.lock` 文件。`--upgrade` 参数是关键。
```bash
uv pip compile pyproject.toml -o uv.lock --upgrade
```
> **重要**: 运行此命令后，你应该将更新后的 `uv.lock` 文件提交到 Git。它是保证团队环境一致性的核心。

**步骤 3.2: 将更新同步到本地环境**
在生成了新的 `uv.lock` 文件后，运行 `sync` 命令来将这些变更应用到你本地的 `.venv` 环境中。
```bash
uv pip sync
```

---
### 附录：命令解析

* `uv init`: 创建项目的“蓝图” (`pyproject.toml`)。
* `uv venv`: 准备一块“空地基” (`.venv`)。
* `uv add`: **功能驱动**。向“蓝图”中添加新工具，并被动更新“施工计划书” (`uv.lock`)。
* `uv pip compile`: **维护驱动**。主动重新规划，生成一份最新的“施工计划书” (`uv.lock`)。
* `uv pip sync`: **执行驱动**。严格按照“施工计划书” (`uv.lock`) 来建造或改造“施工现场” (`.venv`)。
* `uv run`: **运行驱动**。在“施工现场” (`.venv`) 中安全地运行程序。